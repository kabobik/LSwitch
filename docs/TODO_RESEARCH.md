# TODO: Исследования и доработки (2026-02-28)

## Задача 1: Space в event_buffer блокирует Shift+Shift
**Проблема:** Автоконвертация НЕ произошла после нажатия пробела → последний символ в `event_buffer` — пробел. Из-за этого `_extract_last_word_events()` возвращает пустую строку, и принудительная конвертация по Shift+Shift не срабатывает.
**Статус:** [x] Исследование — **Рекомендация: Вариант A** (пропуск trailing spaces в `_extract_last_word_events()`)

## Задача 2: Автоконвертация съедает пробел — слова сливаются
**Проблема:** При срабатывании автоконвертации метод `_do_auto_conversion_at_space()` удаляет trailing space (backspace word_len+1), но после retype пробел может не быть добавлен обратно корректно → два слова сливаются.
**Статус:** [x] Исследование — **Рекомендация: Вариант D** (tap_key(SPACE) в finally + sleep перед replay)

## Задача 3: Shift+Shift не отменяет ложную автоконвертацию
**Проблема:** После автоконвертации `event_buffer` очищается (`ctx.reset()`). Shift+Shift для отмены не работает, потому что буфер пуст и sticky buffer тоже пуст (автоконвертация — не retype).
**Статус:** [x] Исследование — **Рекомендация: Вариант A** (сохранение word_events в marker + явный undo в Case A)

## Задача 4: SelectionMode — PRIMARY вместо CLIPBOARD
**Проблема:** SelectionMode использует CLIPBOARD для вставки текста → мусор в буфере обмена. Предложение: использовать PRIMARY + эмуляция Middle Click. Сохранить старое содержимое PRIMARY, записать новый текст, вставить, вернуть обратно.
**Статус:** [x] Исследование — **Рекомендация: Вариант E** (UInput type_text, clipboard-fallback). PRIMARY+MiddleClick непригоден — вставляет в позицию курсора мыши.

## Задача 5: Запись слов в словарь при Shift+Shift
**Проблема:** При ручной конвертации Shift+Shift нужно записывать слово в user_dictionary с правильными весами для ускорения обучения. Текущая логика (`add_confirmation`/`add_correction`) может работать неоптимально.
**Статус:** [x] Исследование — **Рекомендация: Вариант F** (положительные веса в AutoDetector + вес +2 для ручной конвертации)
