# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ LSwitch - –ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

## –û–±–∑–æ—Ä

LSwitch —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ (DE) –∏ display —Å–µ—Ä–≤–µ—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–¥–∞.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
LSwitch/
‚îú‚îÄ‚îÄ lswitch.py              # –û—Å–Ω–æ–≤–Ω–æ–π –¥–µ–º–æ–Ω (XKB, clipboard, —Å–ª–æ–≤–∞—Ä—å)
‚îú‚îÄ‚îÄ lswitch_control.py      # GUI –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
‚îú‚îÄ‚îÄ utils/                  # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ desktop.py         # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DE –∏ display server
‚îÇ   ‚îî‚îÄ‚îÄ theme.py           # –ß—Ç–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ç–µ–º—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö DE
‚îú‚îÄ‚îÄ adapters/              # –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö DE
‚îÇ   ‚îú‚îÄ‚îÄ base.py           # –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ cinnamon.py       # –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Cinnamon
‚îÇ   ‚îî‚îÄ‚îÄ kde.py            # –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è KDE Plasma
‚îî‚îÄ‚îÄ drivers/              # –î—Ä–∞–π–≤–µ—Ä—ã –¥–ª—è display —Å–µ—Ä–≤–µ—Ä–æ–≤ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
    ‚îú‚îÄ‚îÄ x11.py            # X11/Xlib (—Ç–µ–∫—É—â–∏–π)
    ‚îî‚îÄ‚îÄ wayland.py        # Wayland (TODO)
```

## –ú–æ–¥—É–ª–∏

### utils/desktop.py

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ –∏ display —Å–µ—Ä–≤–µ—Ä.

**–§—É–Ω–∫—Ü–∏–∏:**
- `detect_desktop_environment()` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `'cinnamon'`, `'kde'`, `'gnome'`, `'xfce'`, `'mate'` –∏–ª–∏ `'generic'`
- `detect_display_server()` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `'wayland'` –∏–ª–∏ `'x11'`
- `get_environment_info()` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

**–ü—Ä–∏–º–µ—Ä:**
```python
from utils.desktop import detect_desktop_environment, detect_display_server

de = detect_desktop_environment()  # 'kde'
display = detect_display_server()  # 'x11'
```

### utils/theme.py

–ß–∏—Ç–∞–µ—Ç —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã –∏–∑ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö DE.

**–§—É–Ω–∫—Ü–∏–∏:**
- `get_cinnamon_theme_colors()` - –ü–∞—Ä—Å–∏—Ç GTK CSS —Ñ–∞–π–ª—ã (`/usr/share/themes/*/gtk-3.0/gtk.css`)
- `get_kde_theme_colors()` - –ß–∏—Ç–∞–µ—Ç `~/.config/kdeglobals` —Å–µ–∫—Ü–∏–∏ `[Colors:Window]` –∏ `[Colors:View]`
- `get_theme_colors(de_name)` - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- `get_default_dark_colors()` - Fallback —Ü–≤–µ—Ç–∞ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã

**–§–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```python
{
    'bg_color': (42, 46, 50),      # RGB —Ñ–æ–Ω–∞
    'fg_color': (252, 252, 252),   # RGB —Ç–µ–∫—Å—Ç–∞
    'base_color': (27, 30, 32)     # RGB base (–¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞)
}
```

### adapters/base.py

–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ GUI.

**–ú–µ—Ç–æ–¥—ã:**
- `create_menu(parent=None)` - –°–æ–∑–¥–∞—ë—Ç –º–µ–Ω—é (QMenu –∏–ª–∏ CustomMenu)
- `get_theme_colors()` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã
- `supports_native_menu()` - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω–æ–µ QMenu

### adapters/cinnamon.py

–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Linux Mint Cinnamon.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CustomMenu` (QWidget) –≤–º–µ—Å—Ç–æ QMenu
- –ü—Ä–∏—á–∏–Ω–∞: Cinnamon –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç QMenu –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç Qt stylesheets
- `QMenuWrapper` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API —Å QMenu
- –ß–∏—Ç–∞–µ—Ç —Ü–≤–µ—Ç–∞ –∏–∑ GTK —Ç–µ–º—ã (`/usr/share/themes/*/gtk-3.0/gtk.css`)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `CustomMenuItem` - –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é (48px –≤—ã—Å–æ—Ç–∞, 24px —à—Ä–∏—Ñ—Ç)
- `CustomMenuSeparator` - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å (1px –ª–∏–Ω–∏—è)
- `CustomMenu` - –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –ø—É–Ω–∫—Ç–∞–º–∏ –º–µ–Ω—é
- `QMenuWrapper` - –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å QMenu API

### adapters/kde.py

–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è KDE Plasma.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω–æ–µ `QMenu`
- KDE –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç QPalette –∫ QMenu
- –ß–∏—Ç–∞–µ—Ç —Ü–≤–µ—Ç–∞ –∏–∑ `~/.config/kdeglobals`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ `QPalette` –∏ `QMenu.setStyleSheet()`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–º–æ–π Breeze/Breeze Dark
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ KDE

## –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–æ–≤–æ–≥–æ DE

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ utils/desktop.py

```python
def detect_desktop_environment():
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –≤–∞—à–µ–≥–æ DE
    if 'MYNEWDE' in desktop.upper():
        return 'mynewde'
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å —á—Ç–µ–Ω–∏–µ —Ç–µ–º—ã –≤ utils/theme.py

```python
def get_mynewde_theme_colors():
    """–ß–∏—Ç–∞–µ—Ç —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã MyNewDE"""
    try:
        # –ß–∏—Ç–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª –≤–∞—à–µ–≥–æ DE
        # –í–µ—Ä–Ω–∏—Ç–µ —Å–ª–æ–≤–∞—Ä—å —Å bg_color, fg_color, base_color
        return {
            'bg_color': (R, G, B),
            'fg_color': (R, G, B),
            'base_color': (R, G, B)
        }
    except Exception:
        return None

def get_theme_colors(de_name):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    elif de_name == 'mynewde':
        return get_mynewde_theme_colors()
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä adapters/mynewde.py

```python
from PyQt5.QtWidgets import QMenu
from adapters.base import BaseGUIAdapter
from utils.theme import get_mynewde_theme_colors

class MyNewDEAdapter(BaseGUIAdapter):
    def __init__(self):
        super().__init__()
        self.theme_colors = self.get_theme_colors()
    
    def create_menu(self, parent=None):
        """–°–æ–∑–¥–∞—ë—Ç –º–µ–Ω—é –¥–ª—è MyNewDE"""
        menu = QMenu(None)
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏...
        return menu
    
    def get_theme_colors(self):
        colors = get_mynewde_theme_colors()
        if not colors:
            from utils.theme import get_default_dark_colors
            colors = get_default_dark_colors()
        return colors
    
    def supports_native_menu(self):
        # True –µ—Å–ª–∏ –≤–∞—à–µ DE –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç QMenu —Å —Ç–µ–º–∞–º–∏
        # False –µ—Å–ª–∏ –Ω—É–∂–µ–Ω CustomMenu
        return True
```

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–±—Ä–∏–∫—É –≤ adapters/__init__.py


### X11 Adapter (adapters/x11.py)

`adapters/x11.py` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±–µ—Ä—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ `xclip`/`xdotool` –∏ –¥—Ä—É–≥–∏—Ö X11-—É—Ç–∏–ª–∏—Ç. –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è:
- –∞–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ `xdotool/xclip/xprop/xset`;
- —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏;
- —É–ø—Ä–æ—â–µ–Ω–∏—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö (–≤—Å–µ –≤—ã–∑–æ–≤—ã –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∞–¥–∞–ø—Ç–µ—Ä).

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç:

- get_primary_selection(timeout=0.3) -> str
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ PRIMARY selection (—Å—Ç—Ä–æ–∫–∞) –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ.

- get_clipboard(timeout=0.3) -> str
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ clipboard (CLIPBOARD selection) –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.

- set_clipboard(text: str)
  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ clipboard (CLIPBOARD selection).

- paste_clipboard()
  - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏–º–∏—Ç–∞—Ü–∏—é –≤—Å—Ç–∞–≤–∫–∏ (Ctrl+V) —á–µ—Ä–µ–∑ xdotool.

- cut_selection()
  - –í—ã–ø–æ–ª–Ω—è–µ—Ç Ctrl+X (–ø–æ–ø—ã—Ç–∫–∞ –≤—ã—Ä–µ–∑–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏).

- delete_selection()
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏—à—É Delete –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è (—Ñ–æ–ª–±—ç–∫, –∫–æ–≥–¥–∞ cut –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª).

- shift_left(), ctrl_shift_left()
  - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è (Shift+Left / Ctrl+Shift+Left).

- expand_selection_to_space(max_steps: int = 100, stable_timeout: float = 0.5) -> str
  - –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤–ª–µ–≤–æ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏—Ç –ø—Ä–æ–±–µ–ª (–∏–ª–∏ –Ω–µ –∏—Å—Ç–µ—á—ë—Ç max_steps).
  - –ñ–¥—ë—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ PRIMARY selection (stable_timeout) –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
  - –£–¥–æ–±–Ω–æ –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–π —Å –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π/–∑–∞–ø—è—Ç—ã–º–∏, –≥–¥–µ Shift+Left –º–æ–∂–µ—Ç –Ω–µ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Å–ª–æ–≤–æ —Ü–µ–ª–∏–∫–æ–º.

- safe_replace_selection(converted: str, selected_text: str = None, debug: bool = False) -> str
  - –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `converted`:
    1) –ü—ã—Ç–∞–µ—Ç—Å—è Cut (Ctrl+X) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç clipboard;
    2) –ï—Å–ª–∏ Cut –Ω–µ –ø—Ä–æ—à—ë–ª ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Delete;
    3) –ü–æ–º–µ—â–∞–µ—Ç `converted` –≤ clipboard –∏ –¥–µ–ª–∞–µ—Ç Paste (Ctrl+V);
    4) –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π clipboard (–µ—Å–ª–∏ –±—ã–ª);
    5) –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–µ–π—á–∞—Å –≤ PRIMARY selection.
  - –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É–¥–æ–±–Ω–æ –¥–ª—è assertion/–ª–æ–≥–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö.

- get_active_window_name() -> str
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ (—á–µ—Ä–µ–∑ xdotool) –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.

- get_active_window_class() -> str
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç WM_CLASS –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ (—á–µ—Ä–µ–∑ xprop) –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.

–ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é üîß
- –ê–¥–∞–ø—Ç–µ—Ä —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–¥–µ–ª–∞–Ω –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è: –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏ monkeypatch –≤ —Ç–µ—Å—Ç–∞—Ö (—Å–º. `tests/test_x11_adapter.py`).
- `expand_selection_to_space` –∏ `safe_replace_selection` –ø–æ–∫—Ä—ã—Ç—ã unit-—Ç–µ—Å—Ç–∞–º–∏ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç, –∫–∞–∫ –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –ª–∏–±–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Cut, –ª–∏–±–æ —Ç—Ä–µ–±—É–µ—Ç Delete.

---

### ConversionManager (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å)

`ConversionManager` —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ä—É—á–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: –±—ã—Å—Ç—Ä—ã–π "retype" (—É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ–ø–µ—á–∞—Ç–∞—Ç—å) –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π "selection" (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PRIMARY selection –∏ –≤—Å—Ç–∞–≤–∏—Ç—å). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —è–≤–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö.

**API –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: `ConversionManager(config=None, x11_adapter=None)` ‚Äî –∫–æ–Ω—Ñ–∏–≥ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `app_policies`.
- `choose_mode(buffer, has_selection_fn, backspace_hold=False)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `'retype'` –∏–ª–∏ `'selection'`.
  - –ü—Ä–∞–≤–∏–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
    - –ï—Å–ª–∏ `backspace_hold==True` –∏–ª–∏ `buffer.chars_in_buffer==0` ‚Üí `selection`.
    - –ï—Å–ª–∏ `has_selection_fn()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True ‚Üí `selection`.
    - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è `app_policies` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞) –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ policy-—Ñ—É–Ω–∫—Ü–∏–∏.
    - –§–ª–∞–≥ `prefer_retype_when_possible` –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å `retype` –∫–æ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω–æ.
- `execute(mode, retype_cb, selection_cb)` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π callback.
- –ü–æ–ª–∏—Ç–∏–∫–∏: `app_policies` –≤ –∫–æ–Ω—Ñ–∏–≥–µ ‚Äî –º–∞–ø–ø–∏–Ω–≥ `window_class -> mode` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"Code": "retype"`).
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫: `register_policy(callable)` ‚Äî callable –ø–æ–ª—É—á–∞–µ—Ç `context` –∏ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å `'retype'` | `'selection'` | `None`.

**Default app policies:**
LSwitch –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å –Ω–∞–±–æ—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ (`config.json`):
- IDE/editors ‚Üí `retype` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Code`, `IntelliJ`, `Gedit`)
- Browsers ‚Üí `selection` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Firefox`, `Chromium`)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from conversion import ConversionManager
cm = ConversionManager(config={'prefer_retype_when_possible': True}, x11_adapter=x11_adapter)
mode = cm.choose_mode(buffer, lambda: has_selection(), backspace_hold=False)
cm.execute(mode, retype_cb=lambda: print('retype'), selection_cb=lambda: print('selection'))
```

---

```python
from adapters.mynewde import MyNewDEAdapter

def get_adapter():
    de = detect_desktop_environment()
    
    if de == 'cinnamon':
        return CinnamonAdapter()
    elif de == 'kde':
        return KDEAdapter()
    elif de == 'mynewde':
        return MyNewDEAdapter()
    else:
        # Fallback
        return CinnamonAdapter()
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `test_adapters.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
python3 test_adapters.py
```

–í—ã–≤–æ–¥ –ø–æ–∫–∞–∂–µ—Ç:
- –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ DE –∏ display server
- –í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä
- –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ DE

| DE | –°—Ç–∞—Ç—É—Å | –ê–¥–∞–ø—Ç–µ—Ä | –ú–µ–Ω—é | –¢–µ–º–∞ |
|----|--------|---------|------|------|
| **Cinnamon** | ‚úÖ –ü–æ–ª–Ω–∞—è | CinnamonAdapter | CustomMenu (QWidget) | GTK CSS |
| **KDE Plasma** | ‚úÖ –ü–æ–ª–Ω–∞—è | KDEAdapter | QMenu (–Ω–∞—Ç–∏–≤–Ω–æ–µ) | kdeglobals |
| GNOME Shell | ‚è≥ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | - | - | - |
| XFCE | ‚è≥ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | - | - | - |
| MATE | ‚è≥ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è | - | - | - |

## Roadmap

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞–Ω
- [x] –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [x] –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Cinnamon
- [x] –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è KDE Plasma
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º Cinnamon
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ KDE Wayland

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞–Ω
- [ ] –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è GNOME Shell
- [ ] –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è XFCE
- [ ] Driver abstraction –¥–ª—è X11/Wayland
- [ ] Wayland driver —á–µ—Ä–µ–∑ DBus/ydotool
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ KWin —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–ª—è Wayland

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É CustomMenu –¥–ª—è Cinnamon?

Cinnamon –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Muffin (—Ñ–æ—Ä–∫ Mutter) –∫–∞–∫ –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä. –ü—Ä–∏ –ø–æ–∫–∞–∑–µ QMenu –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Ç—Ä–µ–µ, Muffin –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º–µ–Ω—é –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É—è Qt stylesheets –∏ QPalette.

**–†–µ—à–µ–Ω–∏–µ:** CustomMenu - —ç—Ç–æ QWidget —Å —Ñ–ª–∞–≥–æ–º Qt.Popup, –∫–æ—Ç–æ—Ä—ã–π Cinnamon –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç.

### –ü–æ—á–µ–º—É –Ω–∞—Ç–∏–≤–Ω–æ–µ QMenu –¥–ª—è KDE?

KDE Plasma –∏—Å–ø–æ–ª—å–∑—É–µ—Ç KWin, –∫–æ—Ç–æ—Ä—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å Qt –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏. QMenu –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–º–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ QPalette –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Ç–µ–º–æ–π Breeze.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ QMenu:**
- –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã KDE
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º—É
- Shadows –∏ compositing —ç—Ñ—Ñ–µ–∫—Ç—ã
- –ù–∞—Ç–∏–≤–Ω—ã–π look & feel

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç QMenuWrapper?

`QMenuWrapper` –≤ [adapters/cinnamon.py](adapters/cinnamon.py) –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç `CustomMenu` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å `QMenu`:

```python
class QMenuWrapper:
    def addAction(self, action_or_text):
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç QAction –≤ CustomMenuItem
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (checked, enabled)
        
    def addSeparator(self):
        # –î–æ–±–∞–≤–ª—è–µ—Ç CustomMenuSeparator
        
    def popup(self, pos):
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç CustomMenu –≤—ã—à–µ –∫—É—Ä—Å–æ—Ä–∞
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç `lswitch_control.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–±–æ–∏—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤:

```python
menu = adapter.create_menu()  # QMenu –∏–ª–∏ QMenuWrapper
menu.addAction(action)         # –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö
menu.addSeparator()           # –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
PyQt5 >= 5.15.0
```

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:
- `python3-gi` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GTK —Ç–µ–º–∞–º (Cinnamon)
- `kdeglobals` —Ñ–∞–π–ª –¥–ª—è KDE —Ç–µ–º (–æ–±—ã—á–Ω–æ –µ—Å—Ç—å)

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. [LICENSE](LICENSE)
