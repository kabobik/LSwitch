# LSwitch 2.0 — Инструкция по использованию

## Что это

LSwitch — автоматический переключатель раскладки клавиатуры для Linux (X11). Распознаёт, что текст набирается не в той раскладке, и конвертирует его по двойному нажатию Shift.

**Пример:** набрали `ghbdtn` вместо `привет` → двойной Shift → текст заменён на `привет`, раскладка переключена.

---

## Системные требования

- Linux с X11 (Wayland не поддерживается)
- Python 3.10+
- Системные утилиты: `xclip`, `xdotool`

```bash
# Debian / Ubuntu / Mint
sudo apt install xclip xdotool

# Arch / Manjaro
sudo pacman -S xclip xdotool
```

---

## Установка

### Быстрая установка (рекомендуется)

```bash
cd /path/to/LSwitch
make install
```

Эта команда:
1. Устанавливает Python-пакет с GUI-зависимостями (`pip install -e .[gui]`)
2. Добавляет пользователя в группу `input` (для доступа к evdev)
3. Копирует udev-правила (`/etc/udev/rules.d/99-lswitch.rules`)
4. Устанавливает systemd user-сервис (`~/.config/systemd/user/lswitch.service`)
5. Добавляет `.desktop` файл для меню приложений

> **Важно:** после установки нужно перелогиниться, чтобы членство в группе `input` вступило в силу.

### Только Python-пакет (без системной интеграции)

```bash
pip install -e .           # без GUI
pip install -e .[gui]      # с GUI (PyQt5)
```

---

## Запуск

### Ручной запуск

```bash
# С GUI (иконка в трее)
lswitch

# Без GUI (daemon-режим)
lswitch --headless

# С отладочным выводом
lswitch --debug

# Комбинация
lswitch --headless --debug
```

### Через systemd (автозапуск)

```bash
make enable     # Включить автозапуск + запустить сейчас
make disable    # Отключить автозапуск
make start      # Запустить сервис
make stop       # Остановить
make restart    # Перезапустить
make status     # Показать статус
make logs       # Логи в реальном времени (journalctl -f)
```

Systemd-сервис работает в `--headless` режиме. GUI-панель запускается отдельно командой `lswitch`.

---

## Как пользоваться

### Основной сценарий: конвертация набранного текста

1. Начинаете печатать в неправильной раскладке
2. Замечаете ошибку (например, `ghbdtn` вместо `привет`)
3. **Быстро нажимаете Shift два раза** (двойной клик по Shift)
4. LSwitch удаляет набранный текст, переключает раскладку и вводит правильный вариант

> Таймаут между нажатиями Shift — 0.3 сек (настраивается).

### Режим выделения (selection mode)

1. Выделяете текст мышью или клавиатурой
2. Нажимаете двойной Shift
3. Выделенный текст конвертируется в другую раскладку

### Режим удержания Backspace

1. Удерживаете Backspace (3+ повторов)
2. Нажимаете двойной Shift
3. Включается режим выделения — конвертируется то, что было выделено

### Автоматический выбор режима

LSwitch сам выбирает режим конвертации:
- **Retype** — если есть символы в буфере набора (быстрее, но требует фокус в поле ввода)
- **Selection** — если есть выделенный текст или был удержан Backspace (работает в любом приложении)

---

## Настройка

### Файл конфигурации

```
~/.config/lswitch/config.json
```

Если файла нет — используются настройки по умолчанию. Пример конфига:

```json
{
  "double_click_timeout": 0.3,
  "debug": false,
  "switch_layout_after_convert": true,
  "layout_switch_key": "Alt_L+Shift_L",
  "auto_switch": false,
  "auto_switch_threshold": 10,
  "user_dict_enabled": false,
  "user_dict_min_weight": 2,
  "app_policies": {
    "Code": "retype",
    "Firefox": "selection"
  }
}
```

### Параметры

| Параметр | По умолчанию | Описание |
|----------|-------------|----------|
| `double_click_timeout` | `0.3` | Максимальный интервал между нажатиями Shift (сек). Диапазон: 0.05–10.0 |
| `debug` | `false` | Включить отладочный вывод в журнал |
| `switch_layout_after_convert` | `true` | Переключать раскладку после конвертации |
| `layout_switch_key` | `"Alt_L+Shift_L"` | Комбинация клавиш для переключения раскладки в системе |
| `auto_switch` | `false` | Автоматическое определение раскладки (экспериментально) |
| `auto_switch_threshold` | `10` | Чувствительность автоопределения (чем выше — тем реже срабатывает) |
| `user_dict_enabled` | `false` | Самообучающийся словарь пользователя |
| `user_dict_min_weight` | `2` | Минимальный вес слова для включения в словарь |
| `app_policies` | `{}` | Политики режима по приложениям (см. ниже) |

### Политики приложений

Можно указать предпочтительный режим конвертации для конкретных приложений:

```json
"app_policies": {
  "Code": "retype",
  "IntelliJ": "retype",
  "Firefox": "selection",
  "Chromium": "selection"
}
```

- **retype** — быстрое удаление + перепечатка (лучше для редакторов/IDE)
- **selection** — через буфер обмена (надёжнее для браузеров)

### Горячее обновление конфига

Изменения в `config.json` можно применить без перезапуска:

```bash
make restart
# или
systemctl --user kill -s SIGHUP lswitch.service
```

GUI-панель также отправляет SIGHUP при изменении настроек из трея.

---

## GUI-панель (иконка в трее)

При запуске без `--headless` в системном трее появляется иконка LSwitch. Правый клик открывает меню:

- **Auto-switch** — вкл/выкл автоопределения раскладки
- **Self-learning Dictionary** — вкл/выкл пользовательского словаря
- **Service Management** — статус, запуск, остановка, перезапуск демона
- **About** — информация о версии
- **Quit** — закрыть панель

> Язык интерфейса определяется автоматически по системной локали (русский / английский).

---

## Управление сервисом

```bash
make help       # Список всех команд
```

| Команда | Действие |
|---------|----------|
| `make install` | Полная установка (pip + права + systemd) |
| `make uninstall` | Полное удаление |
| `make start` | Запустить демон |
| `make stop` | Остановить демон |
| `make restart` | Перезапустить демон |
| `make status` | Показать статус |
| `make enable` | Включить автозапуск + запустить |
| `make disable` | Отключить автозапуск |
| `make logs` | Логи в реальном времени |
| `make test` | Запустить тесты |
| `make clean` | Очистить кэши |

---

## Диагностика

### Проверить статус

```bash
make status
# или
systemctl --user status lswitch
```

### Посмотреть логи

```bash
make logs
# или
journalctl --user-unit=lswitch -f
```

### Запустить с отладкой

```bash
lswitch --headless --debug
```

### Частые проблемы

| Проблема | Решение |
|----------|---------|
| `Permission denied` при чтении устройств | Перелогиньтесь (группа `input` применяется при входе) |
| `RuntimeError: X11 недоступен` | Проверьте `echo $DISPLAY` — должно быть `:0` или подобное |
| Конвертация не работает | Убедитесь, что `xclip` и `xdotool` установлены |
| Сервис не запускается | `make logs` — посмотрите ошибку в журнале |
| Двойной Shift не срабатывает | Увеличьте `double_click_timeout` в конфиге (по умолчанию 0.3 сек) |

---

## Удаление

```bash
make uninstall
```

Удаляет: Python-пакет, systemd-сервис, udev-правила, .desktop файл.

Конфигурация (`~/.config/lswitch/`) **не удаляется** — при необходимости удалите вручную.

---

## Версия

```bash
lswitch --version
```
