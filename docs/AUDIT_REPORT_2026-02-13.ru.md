# Отчет аудита LSwitch (2026-02-13)

## Область проверки
- Взаимодействие GUI <-> daemon
- Обработка ввода: выделение левой кнопкой, backspace, стрелки навигации по словам
- Поведение конвертации во время этих событий

## Ключевые находки

### Высокий
1. Путь управления в GUI использует неопределенный `system` и отсутствующий импорт `subprocess`, поэтому несколько операций GUI->daemon не работают.
   - Доказательство: `subprocess` не импортирован в [lswitch_control.py](../lswitch_control.py#L8-L18), но используется в [lswitch_control.py](../lswitch_control.py#L354-L362) и [lswitch_control.py](../lswitch_control.py#L417-L422).
   - Доказательство: `system` используется без определения в [lswitch_control.py](../lswitch_control.py#L485-L496), [lswitch_control.py](../lswitch_control.py#L532-L536), [lswitch_control.py](../lswitch_control.py#L760-L766), [lswitch_control.py](../lswitch_control.py#L794-L804).
   - Влияние: GUI может показывать неверное состояние сервиса, не публиковать раскладки и не посылать сигнал демону.
   - Исправление: добавить `import subprocess`, заменить вызовы `system.*` на `get_system().*` (или последовательно использовать `_system_mod.SYSTEM`), чтобы сохранить DI-хук.

### Средний
2. Тогглы конфигурации в GUI могут не доходить до демона на не-системных установках, потому что демон наблюдает другой файл.
   - Доказательство: демон по умолчанию использует `config_path = 'config.json'`, если `/etc/lswitch/config.json` отсутствует [lswitch/core.py](../lswitch/core.py#L269-L274), но цикл перезагрузки смотрит только на `_config_path` [lswitch/core.py](../lswitch/core.py#L1553-L1562).
   - Влияние: GUI пишет `~/.config/lswitch/config.json`, демон продолжает работать со старыми настройками.
   - Исправление: наблюдать оба пути (системный и пользовательский), или по умолчанию выбирать пользовательский конфиг, если `/etc` отсутствует, или всегда использовать `ConfigManager` в демоне.

3. Определение свежести выделения использует только сравнение строк, поэтому повторное выделение того же текста считается "не свежим", и путь с выделением пропускается.
   - Доказательство: `has_selection()` проверяет только `current_selection != last_known_selection` [lswitch/core.py](../lswitch/core.py#L892-L903).
   - Влияние: повторное выделение того же слова мышью может привести к конвертации последнего буферизованного слова по двойному Shift (или к отсутствию действия) вместо конвертации выделения.
   - Исправление: отслеживать владельца/время выделения, или очищать/обновлять `last_known_selection` по отпусканию мыши, или считать любое непустое выделение свежим, если последним действием была мышь.

4. Флаг удержания backspace сохраняется при новом вводе и может форсировать конвертацию в режиме выделения задолго после окончания удержания.
   - Доказательство: `backspace_hold_detected` выставляется на повторах [lswitch/input.py](../lswitch/input.py#L266-L274), но обычная обработка клавиш его не сбрасывает [lswitch/input.py](../lswitch/input.py#L278-L305).
   - Влияние: после долгого backspace последующий двойной Shift предпочитает выделение даже при наличии буферизованного слова.
   - Исправление: сбрасывать флаг при первом отпускании любой клавиши, кроме backspace, или очищать его, когда метка времени удержания старше короткого порога.

### Низкий
5. `subprocess.DEVNULL` используется без импорта `subprocess` в обработке ввода, поэтому расширение выделения через `xdotool` может не сработать.
   - Доказательство: отсутствует импорт в [lswitch/input.py](../lswitch/input.py#L10-L14), использование в [lswitch/input.py](../lswitch/input.py#L80-L83).
   - Влияние: двойной Shift при пустом буфере/удержании backspace может не выделить слово на системах без адаптера.
   - Исправление: импортировать `subprocess` или убрать `stderr=subprocess.DEVNULL`.

6. Файл раскладок в рантайме записывается неатомарно, пока демон его читает; частичные записи могут парситься как некорректный JSON и игнорироваться.
   - Доказательство: прямая запись в [lswitch_control.py](../lswitch_control.py#L438-L448) и цикл чтения в [lswitch/monitor.py](../lswitch/monitor.py#L77-L96).
   - Влияние: периодические пропуски обновлений раскладок или временно устаревшие данные.
   - Исправление: писать во временный файл и выполнять `os.replace()` атомарно.

## Настройка чувствительности (Ngrams)
- Автоконвертация использует разницу ngram-оценок через `ngrams.should_convert()` с `threshold=ls.config.get('auto_switch_threshold', 10)` в [lswitch/conversion.py](../lswitch/conversion.py#L203-L234) и логику решения в [lswitch/ngrams.py](../lswitch/ngrams.py#L145-L228).
- `auto_switch_threshold` описан в документации, но не попадает в дефолты конфигурации, поэтому может оставаться равным значению по умолчанию; см. [docs/INSTALL.md](../docs/INSTALL.md#L140-L153) и дефолты в [lswitch/config.py](../lswitch/config.py#L16-L97).
- Для авто-конвертации изученных слов используется отдельный `auto_convert_threshold`, который хранится в настройках user dict [lswitch/user_dictionary.py](../lswitch/user_dictionary.py#L67-L76) и применяется в [lswitch/user_dictionary.py](../lswitch/user_dictionary.py#L187-L219).

## Фокус по вводу: ЛКМ, Backspace, стрелки по словам
- Выделение ЛКМ: логика свежести выделения в [lswitch/core.py](../lswitch/core.py#L892-L903) считает повторное выделение того же текста «устаревшим». Это может перенаправить конвертацию в путь буферизованного слова вместо выделения.
- Удержание backspace: флаг «зависает» после сессии удержания [lswitch/input.py](../lswitch/input.py#L266-L305), заставляя конвертер предпочитать режим выделения даже после нового ввода.
- Стрелки по словам: прямой баг в пути конвертации не найден, но навигация стрелками опирается на свежесть выделения при выборе цели конвертации; если выделение «устарело», конвертация может применяться к буферу вместо выделения. Стоит добавить метки времени активности мыши/стрелок для выбора цели.

## Рекомендуемые тесты
1. В GUI переключить `auto_switch` на системе без `/etc/lswitch/config.json` и проверить, что демон подхватывает изменения за 1-2 секунды.
2. Дважды выделить одно и то же слово мышью и нажать двойной Shift; убедиться, что выделение конвертируется в обоих случаях.
3. Удерживать Backspace, чтобы выставить `backspace_hold_detected`, затем набрать новое слово и нажать двойной Shift; проверить конвертацию в режиме retype (а не в режиме выделения).
4. Запустить GUI без адаптера; двойной Shift должен пытаться выделение (без NameError и без «тихого» no-op).
5. Быстро публиковать изменения раскладок; проверить, что демон стабильно обновляет `self.layouts` без ошибок парсинга JSON.
