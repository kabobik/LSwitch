# LSwitch — Внешняя память

Центральное хранилище контекста для координации между агентами.

---

## Последние исследования

### 2026-02-18: Переключение раскладок и баги

**Полный отчёт:** [research_layout_switching.md](research_layout_switching.md)

#### Ключевые находки:

1. **Переключение раскладок:**
   - Текущая реализация — только циклический перебор (`next_index = (current_index + 1) % len(layouts)`)
   - Нет API для переключения на конкретную раскладку по имени
   - Поддерживаются только EN↔RU карты конвертации

2. **Найденные баги:**
   - **Backspace hold:** счётчик `chars_in_buffer` не декрементируется при repeat-событиях
   - **Навигация стрелками:** `cursor_moved_at` не обновляется → `has_selection()` может вернуть False
   - **Race condition:** в replay есть окно между `suppress=False` и установкой `_post_replay_suppress_until`

3. **Рекомендации приоритет 1:**
   - Реализовать `switch_to_layout(target_name)` в xkb.py
   - Добавить обновление `cursor_moved_at` при навигации
   - Исправить порядок операций в replay finally блоке

---

## Архитектура проекта

### Ключевые файлы
| Компонент | Файл |
|-----------|------|
| Работа с раскладками | lswitch/xkb.py |
| Основная логика | lswitch/core.py |
| Обработка ввода | lswitch/input.py |
| Конвертация | lswitch/conversion.py |
| Карты символов | lswitch/conversion_maps.py |

---

## Текущие задачи

- [ ] Реализовать переключение на конкретную раскладку по имени
- [ ] Добавить группы совместимости раскладок (latin, cyrillic, etc.)
- [ ] Исправить баги с backspace hold и навигацией
