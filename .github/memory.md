# LSwitch — Внешняя память

Центральное хранилище контекста для координации между агентами.

---

## Последние исследования

### 2026-02-18: Selection conversion переусложнён

**Проблема:** Режим конвертации выделения делает 10-15 избыточных операций вместо 4 необходимых.

**Текущий алгоритм (плохой):**
1. delete_selection() или cut_selection() — НЕ НУЖНО
2. xclip_set(primary) — БЕСПОЛЕЗНО 
3. set_clipboard + paste
4. retry 3 раза — ОПАСНО
5. восстановление оригинала — ОПАСНО

**Правильный алгоритм (4 шага):**
1. Сохранить старый clipboard
2. set_clipboard(converted)
3. paste (Ctrl+V автоматически заменит выделение!)
4. Восстановить clipboard

**Ключевой инсайт:** Ctrl+V при активном выделении АВТОМАТИЧЕСКИ заменяет текст во ВСЕХ приложениях. Delete/Cut перед Paste — антипаттерн, создающий race conditions.

**Файлы для упрощения:**
- `lswitch/adapters/x11.py:174-223` — safe_replace_selection
- `lswitch/selection.py:163-381` — ~220 строк избыточного кода

---

### 2026-02-18: Переключение раскладок и баги

**Полный отчёт:** [research_layout_switching.md](research_layout_switching.md)

#### Ключевые находки:

1. **Переключение раскладок:**
   - Текущая реализация — только циклический перебор (`next_index = (current_index + 1) % len(layouts)`)
   - Нет API для переключения на конкретную раскладку по имени
   - Поддерживаются только EN↔RU карты конвертации

2. **Найденные баги:**
   - **Backspace hold:** счётчик `chars_in_buffer` не декрементируется при repeat-событиях
   - **Навигация стрелками:** `cursor_moved_at` не обновляется → `has_selection()` может вернуть False
   - **Race condition:** в replay есть окно между `suppress=False` и установкой `_post_replay_suppress_until`

3. **Рекомендации приоритет 1:**
   - Реализовать `switch_to_layout(target_name)` в xkb.py
   - Добавить обновление `cursor_moved_at` при навигации
   - Исправить порядок операций в replay finally блоке

---

## Архитектура проекта

### Ключевые файлы
| Компонент | Файл |
|-----------|------|
| Работа с раскладками | lswitch/xkb.py |
| Основная логика | lswitch/core.py |
| Обработка ввода | lswitch/input.py |
| Конвертация | lswitch/conversion.py |
| Карты символов | lswitch/conversion_maps.py |

---

## Текущие задачи

- [ ] Реализовать переключение на конкретную раскладку по имени
- [ ] Добавить группы совместимости раскладок (latin, cyrillic, etc.)
- [ ] Исправить баги с backspace hold и навигацией
