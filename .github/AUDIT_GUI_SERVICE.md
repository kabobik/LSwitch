# –ê—É–¥–∏—Ç LSwitch ‚Äî GUI, —Å–ª—É–∂–±–∞, —Å–ª–æ–≤–∞—Ä—å, backspace (11 —Ñ–µ–≤—Ä–∞–ª—è 2026)

## –†–µ–∑—é–º–µ

–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã **4 –ø—Ä–æ–±–ª–µ–º—ã**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö **2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–∞** –≤ –∫–æ–¥–µ:

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—É—Ç—å |
|---|---------|-------------|------|
| 1 | –ü–æ–¥–º–µ–Ω—é "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π" | üü° UX | –î–≤–æ–π–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é ‚Äî —Å–≤–æ–π—Å—Ç–≤–æ Qt-–ø–æ–¥–º–µ–Ω—é |
| 2 | –ü—É–Ω–∫—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π" | üü¢ –ù–∏–∑–∫–∞—è | –ù–µ –Ω–µ—Å–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ª—å–∑—ã, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å |
| 3 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | `is_protected()` ‚Äî –∑–∞–≥–ª—É—à–∫–∞, `should_auto_convert()` –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è; `add_conversion()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–±–µ–ª–µ |
| 4 | Backspace hold | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | `elif event.value == 2` –≤–ª–æ–∂–µ–Ω –≤–Ω—É—Ç—Ä—å `if event.value == 0` ‚Üí –¥–µ—Ç–µ–∫—Ü–∏—è —É–¥–µ—Ä–∂–∞–Ω–∏—è **–º—ë—Ä—Ç–≤—ã–π –∫–æ–¥** |

---

## 1. –ü–æ–¥–º–µ–Ω—é "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π" –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∫–ª–∏–∫–µ –≤ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ —ç–∫—Ä–∞–Ω–∞ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥–º–µ–Ω—é "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π", –∏ —Ç–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤–∞ –∫–ª–∏–∫–∞ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ.

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–º–µ–Ω—é** ‚Äî `lswitch_control.py`, –º–µ—Ç–æ–¥ `create_tray_menu()` (—Å—Ç—Ä–æ–∫–∏ ~265‚Äì300):

```python
from PyQt5.QtWidgets import QMenu as QtMenu
self.service_menu = QtMenu("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π")
# ... –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è action'—ã ...
self.menu.addMenu(self.service_menu)
```

–ü–æ–¥–º–µ–Ω—é `service_menu` ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `QMenu`, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é —á–µ—Ä–µ–∑ `addMenu()`.

**–ê–¥–∞–ø—Ç–µ—Ä—ã:**
- **KDEAdapter** (`adapters/kde.py`): `supports_native_menu() ‚Üí True`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π `QMenu`. –ü–æ–¥–º–µ–Ω—é —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –æ–±—Ä–∞–∑–æ–º Qt ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `QMenu` –≤–Ω—É—Ç—Ä–∏ `QMenu`.
- **CinnamonAdapter** (`adapters/cinnamon.py`): `supports_native_menu() ‚Üí False`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `QMenuWrapper` –ø–æ–≤–µ—Ä—Ö `CustomMenu` (–∫–∞—Å—Ç–æ–º–Ω—ã–π `QWidget` —Å `Qt.Popup`). –ú–µ—Ç–æ–¥ `addMenu()` –≤ `QMenuWrapper` (—Å—Ç—Ä–æ–∫–∏ ~365‚Äì395) —Å–æ–∑–¥–∞—ë—Ç **–æ—Ç–¥–µ–ª—å–Ω—ã–π** `CustomMenu` (—Ç–æ–∂–µ `Qt.Popup`) –∏ `CustomSubmenuItem` —Å –ª–æ–≥–∏–∫–æ–π –ø–æ–∫–∞–∑–∞ –ø–æ–¥–º–µ–Ω—é –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏.

**`on_tray_activated()`** (—Å—Ç—Ä–æ–∫–∏ ~630‚Äì637):
```python
def on_tray_activated(self, reason):
    if reason == QSystemTrayIcon.Context:
        self.update_service_status()
        if not self.adapter.supports_native_menu():
            self.menu.popup(QCursor.pos())
```

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

–≠—Ç–æ **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** Qt –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö `QMenu`/Popup-–≤–∏–¥–∂–µ—Ç–æ–≤. –ö–∞–∂–¥—ã–π `Qt.Popup` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ. –ü—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏:
1. Qt –∑–∞–∫—Ä—ã–≤–∞–µ—Ç **—Å–∞–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π** popup (–ø–æ–¥–º–µ–Ω—é).
2. –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –≤–∏–¥–∏—Ç, —á—Ç–æ –∫—É—Ä—Å–æ—Ä –≤–Ω–µ –µ–≥–æ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ **—Å–ª–µ–¥—É—é—â–µ–º** —Å–æ–±—ã—Ç–∏–∏.

–î–ª—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ `QMenu` (KDE) —ç—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Qt –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–æ –±–µ–∑ —Ö–∞–∫–æ–≤. –î–ª—è `CustomMenu` (Cinnamon) ‚Äî –æ–±–∞ –≤–∏–¥–∂–µ—Ç–∞ –∏–º–µ—é—Ç `Qt.Popup`, –∏ –∫–∞–∂–¥—ã–π –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.

### –†–µ—à–µ–Ω–∏–µ

**–í–∞—Ä–∏–∞–Ω—Ç A: –£–±—Ä–∞—Ç—å –ø–æ–¥–º–µ–Ω—é, –≤—ã–Ω–µ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –≤ –ø–ª–æ—Å–∫–æ–µ –º–µ–Ω—é** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –í—Å–µ 6 –ø—É–Ω–∫—Ç–æ–≤ (–°—Ç–∞—Ç—É—Å, –ó–∞–ø—É—Å—Ç–∏—Ç—å, –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å, –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫, –†–∞–∑—Ä–µ—à–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) –≤—ã–Ω–µ—Å—Ç–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è.
- –ü–ª—é—Å—ã: –æ–¥–∏–Ω –∫–ª–∏–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—ë, UX –ø—Ä–æ—â–µ.
- –ú–∏–Ω—É—Å—ã: –º–µ–Ω—é —Å—Ç–∞–Ω–µ—Ç –¥–ª–∏–Ω–Ω–µ–µ.

**–í–∞—Ä–∏–∞–Ω—Ç B: –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–¥–º–µ–Ω—é**
- –í `CustomMenu` –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `hideEvent()` –∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
- –î–ª—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ `QMenu` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `aboutToHide` —Å–∏–≥–Ω–∞–ª –ø–æ–¥–º–µ–Ω—é –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ.
- –ú–∏–Ω—É—Å—ã: —Ö—Ä—É–ø–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í–∞—Ä–∏–∞–Ω—Ç A.** –ü–æ–¥–º–µ–Ω—é –¥–ª—è 5 –∫–Ω–æ–ø–æ–∫ ‚Äî overengineering. –ü–ª–æ—Å–∫–æ–µ –º–µ–Ω—é –ø—Ä–æ—â–µ –∏ —É–¥–æ–±–Ω–µ–µ. –ú–æ–∂–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –±–ª–æ–∫ "–°–ª—É–∂–±–∞" —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º-–∑–∞–≥–ª—É—à–∫–æ–π.

---

## 2. –ü—É–Ω–∫—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π"

### –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–í—Å–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–¥–µ:**

| –§–∞–π–ª | –°—Ç—Ä–æ–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|-------|--------|--------------|
| `lswitch_control.py` | 292 | `allow_manage_action.setChecked(config.get('gui_manage_service', True))` ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–∞ |
| `lswitch_control.py` | 384 | `if not self.config.get('gui_manage_service', True): ...` ‚Äî –≤ `run_systemctl()`, –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ |
| `lswitch_control.py` | 651‚Äì654 | `toggle_service_management()` ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ñ–∏–≥ |
| `config/config.json.example` | 12 | `"gui_manage_service": true` ‚Äî –ø—Ä–∏–º–µ—Ä |
| `tests/test_gui_manage_service.py` | 29 | –¢–µ—Å—Ç: –ø—Ä–∏ `False` `run_systemctl` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è |

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `gui_manage_service`:**
- –ü—Ä–∏ `False`: –º–µ—Ç–æ–¥ `run_systemctl()` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö GUI" –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`.
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç: `start_service()`, `stop_service()`, `restart_service()`, `toggle_autostart()`.
- **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç:** —á—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI, –∏ —Ç.–¥.

**–í–∞–∂–Ω–æ:** `gui_manage_service` –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `lswitch/config.py` (–≤–∞–ª–∏–¥–∞—Ü–∏—è). –ö–ª—é—á –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –£–ë–†–ê–¢–¨

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–ù–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ use-case.** –≠—Ç–æ user-level —Å–µ—Ä–≤–∏—Å (`systemctl --user`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∞ PolicyKit/sudoers, –∞ –Ω–µ GUI-—á–µ–∫–±–æ–∫—Å–∞.
2. **–°–∞–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–ª—É—á–∞–π–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –Ω–µ –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –∂–µ GUI (—á–µ–∫–±–æ–∫—Å), —á—Ç–æ –Ω–µ–ª–æ–≥–∏—á–Ω–æ.
3. **–ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º.** –ó–Ω–∞—á–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ñ–∏–≥–µ, –∞ –Ω–µ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ.
4. **–î–æ–±–∞–≤–ª—è–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å.** –ö–æ–¥ `run_systemctl()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º.

### –ö–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è

**`lswitch_control.py`:**
1. –°—Ç—Ä–æ–∫–∏ ~288‚Äì294 ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ `allow_manage_action` –≤ `create_tray_menu()`:
   ```python
   self.allow_manage_action = QAction("–†–∞–∑—Ä–µ—à–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π (GUI)", self.service_menu)
   self.allow_manage_action.setCheckable(True)
   self.allow_manage_action.setChecked(self.config.get('gui_manage_service', True))
   self.allow_manage_action.triggered.connect(self.toggle_service_management)
   self.service_menu.addAction(self.allow_manage_action)
   ```

2. –°—Ç—Ä–æ–∫–∏ ~384‚Äì390 ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `run_systemctl()`:
   ```python
   if not self.config.get('gui_manage_service', True):
       try:
           self.showMessage(...)
       except Exception:
           pass
       return False
   ```

3. –°—Ç—Ä–æ–∫–∏ ~647‚Äì657 ‚Äî –º–µ—Ç–æ–¥ `toggle_service_management()` (—Ü–µ–ª–∏–∫–æ–º).

**`config/config.json.example`:**
- –°—Ç—Ä–æ–∫–∞ 12: `"gui_manage_service": true,`

**`tests/test_gui_manage_service.py`:**
- –í–µ—Å—å —Ñ–∞–π–ª (—Å—Ç–∞–Ω–µ—Ç –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–º).

---

## 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å

### –¶–µ–ø–æ—á–∫–∞ –≤—ã–∑–æ–≤–æ–≤

#### –†—É—á–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (double-shift ‚Üí –ø—Ä–æ–±–µ–ª):
```
1. Double-shift ‚Üí on_double_shift()
2. ‚Üí convert_and_retype(is_auto=False)
3.   ‚Üí last_manual_convert = {original, converted, from_lang, to_lang, time}
4.   ‚Üí clear_buffer()  # –Ω–µ –æ—á–∏—â–∞–µ—Ç last_manual_convert ‚úì
5.   ‚Üí backspace + switch layout + replay events
6.   ‚Üí is_converting = False
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –ü–†–û–ë–ï–õ (–∏–ª–∏ —Å–ª–µ–¥—É—é—â—É—é –±—É–∫–≤—É)
8. InputHandler.handle_event() ‚Üí
9.   [–ü—É—Ç—å 1: —Å—Ç—Ä–æ–∫–∞ 276+] chars_in_buffer++,
      –ø—Ä–æ–≤–µ—Ä—è–µ—Ç last_manual_convert ‚Üí add_conversion() ‚Üê –í–´–ó–û–í 1
      –ù–ï –æ—á–∏—â–∞–µ—Ç last_manual_convert (event.code == KEY_SPACE)
10.  [–ü—É—Ç—å 2: —Å—Ç—Ä–æ–∫–∞ 305+] –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–∞:
      —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç last_manual_convert ‚Üí add_conversion() ‚Üê –í–´–ó–û–í 2!
```

#### –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:
```
1. –ü—Ä–æ–±–µ–ª ‚Üí check_and_auto_convert()
2. ‚Üí ngrams.should_convert(word, user_dict=user_dict)
3.   ‚Üí –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–ª–æ–≤–∞—Ä—è—Ö RU/EN
4.   ‚Üí –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1.5: user_dict.is_protected() ‚Üí –í–°–ï–ì–î–ê (False, 0)!
5.   ‚Üí –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤ —Ü–µ–ª–µ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ
6.   ‚Üí –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3-4: N-gram –∞–Ω–∞–ª–∏–∑
7. –ï—Å–ª–∏ should_convert=True ‚Üí convert_and_retype(is_auto=True)
```

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 3.1: `is_protected()` ‚Äî –ó–ê–ì–õ–£–®–ö–ê (–º—ë—Ä—Ç–≤—ã–π –∫–æ–¥)

–§–∞–π–ª: `lswitch/user_dictionary.py`, —Å—Ç—Ä–æ–∫–∏ 378‚Äì385:
```python
def is_protected(self, word, lang):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"""
    return (False, 0)  # –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False!
```

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `ngrams.py` —Å—Ç—Ä–æ–∫–∞ 190:
```python
if user_dict:
    protected, weight = user_dict.is_protected(text_lower, current_lang)
    if protected:  # <-- –ù–ò–ö–û–ì–î–ê True
        return (False, text, f"user_dict_protected ...")
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª (–æ—Ç–º–µ–Ω—è–ª –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é), **–Ω–µ –∑–∞—â–∏—â–µ–Ω—ã** –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ.

#### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 3.2: `should_auto_convert()` –ù–ò–ì–î–ï –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø

–ú–µ—Ç–æ–¥ `UserDictionary.should_auto_convert()` (—Å—Ç—Ä–æ–∫–∞ 187) **—Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω** ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Å —Å–ª–æ–≤–∞ –∏ —Ä–µ—à–∞–µ—Ç, –Ω—É–∂–Ω–∞ –ª–∏ –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è. –ù–æ –æ–Ω **–Ω–∏ —Ä–∞–∑—É –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** –Ω–∏–≥–¥–µ –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ:

```
$ grep -r "should_auto_convert" lswitch/
user_dictionary.py:    def should_auto_convert(...)  # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
# –ù–∏–∫–∞–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤!
```

`check_and_auto_convert()` –≤ `conversion.py` –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `ngrams.should_convert()`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç N-–≥—Ä–∞–º–º—ã –∏ —Å–ª–æ–≤–∞—Ä–∏, –Ω–æ **–Ω–µ user_dict.should_auto_convert()**.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** –°–∞–º–æ–æ–±—É—á–∞—é—â–∏–π—Å—è —Å–ª–æ–≤–∞—Ä—å **–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ** (`add_conversion` —Ä–∞–±–æ—Ç–∞–µ—Ç), –Ω–æ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –æ–± –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏. –°–ª–æ–≤–∞—Ä—å —É—á–∏—Ç—Å—è, –Ω–æ –µ–≥–æ –∑–Ω–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.

#### üü° –ü—Ä–æ–±–ª–µ–º–∞ 3.3: –î–≤–æ–π–Ω–æ–π –≤—ã–∑–æ–≤ `add_conversion()` –ø—Ä–∏ –ø—Ä–æ–±–µ–ª–µ

–í `input.py`, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø—Ä–æ–±–µ–ª–∞ –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:
1. **–°—Ç—Ä–æ–∫–∞ ~284**: –æ–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤—ã–∑—ã–≤–∞–µ—Ç `add_conversion()` –¥–ª—è –í–°–ï–• –∫–ª–∞–≤–∏—à, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª.
2. **–°—Ç—Ä–æ–∫–∞ ~309**: —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–±–µ–ª–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `add_conversion()` –ø–æ–≤—Ç–æ—Ä–Ω–æ.

–£—Å–ª–æ–≤–∏–µ `if event.code != KEY_SPACE: self.last_manual_convert = None` (—Å—Ç—Ä–æ–∫–∞ 298) –ù–ï –æ—á–∏—â–∞–µ—Ç –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø—Ä–æ–±–µ–ª–∞, –ø–æ—ç—Ç–æ–º—É –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** –í–µ—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 2 –≤–º–µ—Å—Ç–æ 1 –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø—Ä–æ–±–µ–ª–æ–º. –ù–µ —Ñ–∞—Ç–∞–ª—å–Ω–æ, –Ω–æ –∏—Å–∫–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

#### üü¢ –ü—Ä–æ–±–ª–µ–º–∞ 3.4: Backspace –æ—á–∏—â–∞–µ—Ç `last_manual_convert`

–í `input.py` —Å—Ç—Ä–æ–∫–∏ 260‚Äì261:
```python
if self.ls.last_manual_convert:
    self.ls.last_manual_convert = None
```

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç backspace –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (—á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫—É), –º–∞—Ä–∫–µ—Ä –æ—á–∏—â–∞–µ—Ç—Å—è –∏ `add_conversion` –Ω–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–æ–±–µ–ª–µ. –≠—Ç–æ —É–º–µ—Ä–µ–Ω–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (backspace = —Å–æ–º–Ω–µ–Ω–∏–µ), –Ω–æ –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**3.1 ‚Äî –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `is_protected()`:**
```python
def is_protected(self, word, lang):
    canonical = self._canonicalize(word, lang)
    if canonical not in self.data['conversions']:
        return (False, 0)
    entry = self.data['conversions'][canonical]
    weight = entry.get('weight', 0)
    # –ï—Å–ª–∏ –≤–µ—Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –ü–†–û–¢–ò–í –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ ‚Äî —Å–ª–æ–≤–æ –∑–∞—â–∏—â–µ–Ω–æ
    if lang == 'ru' and weight < 0:
        return (True, weight)  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å RU
    if lang == 'en' and weight > 0:
        return (True, weight)  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å EN
    return (False, weight)
```

**3.2 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `should_auto_convert()` –≤ `check_and_auto_convert()`:**

–í `conversion.py`, —Ñ—É–Ω–∫—Ü–∏—è `check_and_auto_convert()`, –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `ngrams.should_convert()`:
```python
# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 0: user_dict —Ä–µ—à–∞–µ—Ç –∞–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –ø–æ –≤–µ—Å—É
if user_dict:
    from_lang = ... # –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫
    to_lang = 'en' if from_lang == 'ru' else 'ru'
    if user_dict.should_auto_convert(word, from_lang, to_lang):
        # user_dict –≥–æ–≤–æ—Ä–∏—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å - –¥–µ–ª–∞–µ–º
        ...
```

**3.3 ‚Äî –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:**

–í `input.py`, –≤ –±–ª–æ–∫–µ –æ–±—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~276), **–∏—Å–∫–ª—é—á–∏—Ç—å** KEY_SPACE –∏–∑ –≤—ã–∑–æ–≤–∞ `add_conversion`:
```python
if event.value == 0 and event.code not in (KEY_LEFTSHIFT, KEY_RIGHTSHIFT, KEY_BACKSPACE, KEY_SPACE):
```
–û—Å—Ç–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ç–æ–ª—å–∫–æ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø—Ä–æ–±–µ–ª–∞.

---

## 4. Backspace hold

### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞

**–û–∂–∏–¥–∞–µ–º—ã–π –ø–æ—Ç–æ–∫:**
1. –£–¥–µ—Ä–∂–∞–Ω–∏–µ Backspace ‚Üí —Å–µ—Ä–∏—è repeat-—Å–æ–±—ã—Ç–∏–π (value=2)
2. –ü—Ä–∏ 3+ repeat: `backspace_hold_detected = True`
3. Release (value=0): `consecutive_backspace_repeats = 0`
4. Double-shift ‚Üí `choose_mode()` –≤–∏–¥–∏—Ç `backspace_hold_detected=True` ‚Üí mode='selection'
5. Selection-mode: Ctrl+Shift+Left –≤—ã–¥–µ–ª—è–µ—Ç —Å–ª–æ–≤–æ ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ clipboard

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏

#### üî¥ –ë–∞–≥ 4.1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô ‚Äî –î–µ—Ç–µ–∫—Ü–∏—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –≤ `input.py` ‚Äî –ú–Å–†–¢–í–´–ô –ö–û–î

–§–∞–π–ª: `lswitch/input.py`, —Å—Ç—Ä–æ–∫–∏ 254‚Äì275:

```python
if event.value == 0:                                        # ‚Üê value –¢–û–ß–ù–û 0
    if event.code == getattr(ecodes, 'KEY_BACKSPACE', None):
        self.ls.had_backspace = True
        self.ls.consecutive_backspace_repeats = 0
        ...
    elif event.value == 2:  # repeat                        # ‚Üê –ú–Å–†–¢–í–´–ô –ö–û–î!
        if event.code == getattr(ecodes, 'KEY_BACKSPACE', None):
            self.ls.consecutive_backspace_repeats += 1      # ‚Üê –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
            if self.ls.consecutive_backspace_repeats >= 3:
                ...self.ls.backspace_hold_detected = True    # ‚Üê –ù–ò–ö–û–ì–î–ê –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** `elif event.value == 2` —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –∫–∞–∫ –≤–µ—Ç–∫–∞ `elif` –∫ `if event.code == KEY_BACKSPACE`, –∞ –ù–ï –∫ `if event.value == 0`. –ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ `if event.value == 0`, —É—Å–ª–æ–≤–∏–µ `event.value == 2` **–≤—Å–µ–≥–¥–∞ False**.

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤ `core.py` (legacy-–ø—É—Ç—å, —Å—Ç—Ä–æ–∫–∏ 1359‚Äì1397) —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ **–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è**:
```python
if event.value == 0:        # –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ
    if event.code == ecodes.KEY_BACKSPACE:
        ...
elif event.value == 2:      # Repeat ‚Üê –ù–ê –¢–û–ú –ñ–ï –£–†–û–í–ù–ï, —Ä–∞–±–æ—Ç–∞–µ—Ç!
    if event.code == ecodes.KEY_BACKSPACE:
        ...
```

–ù–æ legacy-–ø—É—Ç—å –≤ `core.py` **–ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è**, –ø–æ—Ç–æ–º—É —á—Ç–æ `InputHandler` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –¥–ª—è active_keycodes, –∏ `handle_event()` –≤ core.py –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1250: `if _res is not None: return _res`.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** `backspace_hold_detected` **–ù–ò–ö–û–ì–î–ê** –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `True` –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `InputHandler` (–ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é). –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø–æ—Å–ª–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è Backspace –≤—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mode='retype' —Å –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º.

#### üü° –ë–∞–≥ 4.2: `backspace_hold_detected_at` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è**

–í `clear_buffer()` (`core.py`, —Å—Ç—Ä–æ–∫–∏ 815‚Äì822):
```python
if getattr(self, 'backspace_hold_detected_at', 0) and \
   (time.time() - self.backspace_hold_detected_at) < 0.5:
    # Preserve backspace_hold_detected
else:
    self.backspace_hold_detected = False
    self.backspace_hold_detected_at = 0.0
```

–≠—Ç–æ—Ç –∫–æ–¥ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `backspace_hold_detected` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `clear_buffer()`, –µ—Å–ª–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –±—ã–ª–æ –Ω–µ–¥–∞–≤–Ω–∏–º (< 0.5s). **–ù–æ `backspace_hold_detected_at` –ù–ò–ì–î–ï –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è** –Ω–∞ `time.time()`:

```
$ grep -n "backspace_hold_detected_at\s*=" lswitch/
core.py:822:    self.backspace_hold_detected_at = 0.0   # –¢–æ–ª—å–∫–æ —Å–±—Ä–æ—Å!
processors/buffer_manager.py:23:  self.backspace_hold_detected_at = 0.0  # –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è!
processors/buffer_manager.py:58:  self.backspace_hold_detected_at = 0.0  # –¢–æ–ª—å–∫–æ —Å–±—Ä–æ—Å!
```

–ù–∏ –≤ `input.py`, –Ω–∏ –≤ `core.py` –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ `self.backspace_hold_detected_at = time.time()` —Ä—è–¥–æ–º —Å `self.backspace_hold_detected = True`.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** –õ–æ–≥–∏–∫–∞ "preserve recent hold" ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥. `clear_buffer()` **–í–°–ï–ì–î–ê** —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `backspace_hold_detected` –≤ `False`.

#### üü° –ë–∞–≥ 4.3: –î–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ repeat-backspace

–î–∞–∂–µ –µ—Å–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–≥ 4.1, –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–∞:
- –ü—Ä–∏ repeat (value=2) `chars_in_buffer` **–Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è** (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "–ù–ï —Ç—Ä–æ–≥–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ - –æ–Ω–∏ –Ω–µ —Ç–æ—á–Ω—ã–µ –ø—Ä–∏ repeats!").
- –ü—Ä–∏ release (value=0) `chars_in_buffer -= 1` (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑).
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–µ—Ä–∂–∏–≤–∞–ª backspace –∏ —É–¥–∞–ª–∏–ª 10 —Å–∏–º–≤–æ–ª–æ–≤, `chars_in_buffer` —É–º–µ–Ω—å—à–∏–ª—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ 1 (release), –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 9 –≤–º–µ—Å—Ç–æ 0.
- `text_buffer` —Ç–æ–∂–µ —Ç–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ 1 —Å–∏–º–≤–æ–ª –≤–º–µ—Å—Ç–æ 10.

–≠—Ç–æ **by design** (selection mode –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±—É—Ñ–µ—Ä), –Ω–æ –µ—Å–ª–∏ `backspace_hold_detected` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç (–±–∞–≥ 4.1), —Ç–æ `choose_mode()` –≤–µ—Ä–Ω—ë—Ç 'retype' —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å–ª–æ–º–∞–µ—Ç—Å—è.

#### üü¢ –ë–∞–≥ 4.4: –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ `print()` –≤ production-–∫–æ–¥–µ

–í `core.py` —Å—Ç—Ä–æ–∫–∏ 1384‚Äì1386:
```python
print('DEBUG: repeat branch entered, before=', self.consecutive_backspace_repeats)
...
print('DEBUG: repeat branch after=', self.consecutive_backspace_repeats)
```

–≠—Ç–∏ `print()` –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã `if self.config.get('debug'):` –∏ –±—É–¥—É—Ç –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ production-–ª–æ–≥–∏.

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**4.1 ‚Äî –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å –≤ `input.py`:**

–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 254‚Äì275):
```python
            if event.value == 0:
                if event.code == getattr(ecodes, 'KEY_BACKSPACE', None):
                    ...
                elif event.value == 2:  # ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!
                    ...
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```python
            if event.value == 0:
                if event.code == getattr(ecodes, 'KEY_BACKSPACE', None):
                    ...
            elif event.value == 2:  # ‚Üê –í—ã–Ω–µ—Å—Ç–∏ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å parent-if
                if event.code == getattr(ecodes, 'KEY_BACKSPACE', None):
                    ...
                else:
                    self.ls.consecutive_backspace_repeats = 0
```

**4.2 ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `backspace_hold_detected_at`:**

–í `input.py`, –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ `backspace_hold_detected = True`, –¥–æ–±–∞–≤–∏—Ç—å:
```python
self.ls.backspace_hold_detected = True
self.ls.backspace_hold_detected_at = time.time()  # ‚Üê –î–û–ë–ê–í–ò–¢–¨
```

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤ `core.py` (legacy path) —Å—Ç—Ä–æ–∫–∞ 1388.

**4.4 ‚Äî –£–±—Ä–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ print –∏–∑ production:**

–û–±–µ—Ä–Ω—É—Ç—å –≤ `if self.config.get('debug'):` –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–æ–±–ª–µ–º–∞ | –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ |
|-----------|---------|-----------------|
| üî¥ P0 | **4.1**: Backspace hold ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ `elif` | 5 –º–∏–Ω, 1 —Å—Ç—Ä–æ–∫–∞ |
| üî¥ P0 | **3.1 + 3.2**: User dictionary ‚Äî `is_protected()` –∑–∞–≥–ª—É—à–∫–∞ + `should_auto_convert()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | 30 –º–∏–Ω, 3 —Ñ–∞–π–ª–∞ |
| üü° P1 | **4.2**: `backspace_hold_detected_at` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è | 5 –º–∏–Ω, 2 —Ñ–∞–π–ª–∞ |
| üü° P1 | **3.3**: –î–≤–æ–π–Ω–æ–π `add_conversion()` –ø—Ä–∏ –ø—Ä–æ–±–µ–ª–µ | 10 –º–∏–Ω, 1 —Ñ–∞–π–ª |
| üü° P1 | **1**: –ü–æ–¥–º–µ–Ω—é ‚Üí –ø–ª–æ—Å–∫–æ–µ –º–µ–Ω—é | 20 –º–∏–Ω, 1 —Ñ–∞–π–ª |
| üü¢ P2 | **2**: –£–±—Ä–∞—Ç—å `gui_manage_service` | 15 –º–∏–Ω, 3 —Ñ–∞–π–ª–∞ |
| üü¢ P2 | **4.4**: –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ print –≤ production | 2 –º–∏–Ω, 1 —Ñ–∞–π–ª |

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–æ–≤:** 4.1 ‚Üí 4.2 ‚Üí 3.1+3.2 ‚Üí 3.3 ‚Üí 1 ‚Üí 2 ‚Üí 4.4
